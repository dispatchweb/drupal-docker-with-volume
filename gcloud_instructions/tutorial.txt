# Drupal container

# Tutorials: 
# https://cloud.google.com/container-engine/docs/quickstart
# adapted from https://cloud.google.com/container-engine/docs/tutorials/persistent-disk/#wordpress_pod

# Follow https://developers.google.com/identity/protocols/application-default-credentials to get credentials and store the json file in this folder

# Set environment variable to this set of creds
export GOOGLE_APPLICATION_CREDENTIALS=DrupalContainerEngine-f8ef8a6dc869.json

# Update gcloud
gcloud components update

# install kubernetes command line
gcloud components install kubectl

# Set to europe for all future commands
gcloud config set compute/zone europe-west1-b

# List properties
gcloud config list

# Set to our project. Make sure this exists in the UI.
gcloud config set project drupalcontainerengine

# initialize the cluster
gcloud container clusters create drupalpd \
--machine-type "n1-standard-1" \
--image-type "GCI" \
--disk-size "100" \
--scopes "https://www.googleapis.com/auth/compute","https://www.googleapis.com/auth/devstorage.read_only","https://www.googleapis.com/auth/logging.write","https://www.googleapis.com/auth/servicecontrol","https://www.googleapis.com/auth/service.management.readonly","https://www.googleapis.com/auth/trace.append" --num-nodes 2 \
--network "default" \
--enable-cloud-logging \
--no-enable-cloud-monitoring \
--enable-autoupgrade

# creation of the persistent disks for drupal and mysql
gcloud compute disks create --size 100GB mysql-disk
gcloud compute disks create --size 100GB drupal-disk

# Create the Mysql Pod
kubectl create -f mysql.yaml

# Verify if it is running. Wait till it says "Running"
kubectl get pod mysql

# Create the mysql service
kubectl create -f mysql-service.yaml

# verify if it is running
kubectl get service mysql

# Create the Drupal pod
kubectl create -f drupal8.yaml

# Verify the drupal8 pod
kubectl get pod drupal8

# Create drupal service
kubectl create -f drupal8-service.yaml

# verify
kubectl get service drupal8frontend

# Get our properties in order to visit our site. Wait till it mentions a property like: "LoadBalancer Ingress". It might take a while before the load balancer is created.
kubectl describe service drupal8frontend

# Log in to our kubernetes panel
gcloud container clusters get-credentials drupalpd \
    --zone europe-west1-b --project drupalcontainerengine

kubectl proxy

# Browse to http://localhost:8001/ui